name: Docker Layer Count Check
# This workflow checks that PRs don't increase Docker layer counts in ecosystem Dockerfiles.
# Adding layers to Docker images affects build performance and caching efficiency.
# This check is NOT required to merge PRs but will show as a failure if layers are added.

on: # yamllint disable-line rule:truthy
  pull_request:
    paths:
      # Only run when Dockerfile-related files change
      - "*/Dockerfile"
      - "Dockerfile.updater-core"

permissions: {}

jobs:
  detect-dockerfiles:
    name: Detect Changed Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      dockerfiles: ${{ steps.find-dockerfiles.outputs.dockerfiles }}
      has-changes: ${{ steps.find-dockerfiles.outputs.has-changes }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Find changed Dockerfiles
        id: find-dockerfiles
        run: |
          # Get changed files between base and head
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Filter for Dockerfiles (in ecosystem directories and root)
          CHANGED_DOCKERFILES=$(echo "$CHANGED_FILES" | grep -E '^[^/]+/Dockerfile$|^Dockerfile\.updater-core$' || true)

          if [ -z "$CHANGED_DOCKERFILES" ]; then
            echo "No Dockerfile changes detected"
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "dockerfiles=[]" >> "$GITHUB_OUTPUT"
          else
            echo "Changed Dockerfiles:"
            echo "$CHANGED_DOCKERFILES"

            # Build JSON array of changed Dockerfiles
            # Format: [{"path": "bundler/Dockerfile", "ecosystem": "bundler"}, ...]
            JSON_ARRAY="["
            FIRST=true
            while IFS= read -r dockerfile; do
              if [ -n "$dockerfile" ]; then
                # Extract ecosystem name from path
                if [ "$dockerfile" = "Dockerfile.updater-core" ]; then
                  ECOSYSTEM="updater-core"
                else
                  ECOSYSTEM=$(dirname "$dockerfile")
                fi

                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  JSON_ARRAY="$JSON_ARRAY,"
                fi
                JSON_ARRAY="$JSON_ARRAY{\"path\":\"$dockerfile\",\"ecosystem\":\"$ECOSYSTEM\"}"
              fi
            done <<< "$CHANGED_DOCKERFILES"
            JSON_ARRAY="$JSON_ARRAY]"

            echo "dockerfiles=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
          fi

  check-layers:
    name: Check Layers - ${{ matrix.dockerfile.ecosystem }}
    runs-on: ubuntu-latest
    needs: detect-dockerfiles
    if: needs.detect-dockerfiles.outputs.has-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        dockerfile: ${{ fromJSON(needs.detect-dockerfiles.outputs.dockerfiles) }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
          path: pr

      - name: Checkout base branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.base_ref }}
          persist-credentials: false
          path: base

      - name: Count layers in base branch
        id: base-layers
        run: |
          # Count the number of instruction lines that create layers in the base Dockerfile
          # Layer-creating instructions: FROM, RUN, COPY, ADD
          # We count these instead of building to be fast and avoid needing Docker
          DOCKERFILE_PATH="base/${{ matrix.dockerfile.path }}"

          if [ ! -f "$DOCKERFILE_PATH" ]; then
            echo "Dockerfile doesn't exist in base branch (new file)"
            echo "count=0" >> "$GITHUB_OUTPUT"
            echo "is-new=true" >> "$GITHUB_OUTPUT"
          else
            # Count layer-creating instructions
            # Using grep with extended regex to match FROM, RUN, COPY, ADD at the start of lines
            # Excluding comments and accounting for multi-line commands (lines ending with \)
            COUNT=$(grep -cE '^\s*(FROM|RUN|COPY|ADD)\s' "$DOCKERFILE_PATH" || echo "0")
            echo "Base branch layer count: $COUNT"
            echo "count=$COUNT" >> "$GITHUB_OUTPUT"
            echo "is-new=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Count layers in PR branch
        id: pr-layers
        run: |
          DOCKERFILE_PATH="pr/${{ matrix.dockerfile.path }}"

          if [ ! -f "$DOCKERFILE_PATH" ]; then
            echo "Dockerfile doesn't exist in PR branch (deleted file)"
            echo "count=0" >> "$GITHUB_OUTPUT"
            echo "is-deleted=true" >> "$GITHUB_OUTPUT"
          else
            # Count layer-creating instructions
            COUNT=$(grep -cE '^\s*(FROM|RUN|COPY|ADD)\s' "$DOCKERFILE_PATH" || echo "0")
            echo "PR branch layer count: $COUNT"
            echo "count=$COUNT" >> "$GITHUB_OUTPUT"
            echo "is-deleted=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compare layer counts
        id: compare
        run: |
          BASE_COUNT=${{ steps.base-layers.outputs.count }}
          PR_COUNT=${{ steps.pr-layers.outputs.count }}
          IS_NEW=${{ steps.base-layers.outputs.is-new }}
          IS_DELETED=${{ steps.pr-layers.outputs.is-deleted }}

          echo "## Docker Layer Count Check: ${{ matrix.dockerfile.ecosystem }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dockerfile | Base Layers | PR Layers | Change |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------------|-------------|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"

          if [ "$IS_DELETED" = "true" ]; then
            echo "| ${{ matrix.dockerfile.path }} | $BASE_COUNT | (deleted) | âœ… Removed |" >> "$GITHUB_STEP_SUMMARY"
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=Dockerfile was deleted" >> "$GITHUB_OUTPUT"
          elif [ "$IS_NEW" = "true" ]; then
            echo "| ${{ matrix.dockerfile.path }} | (new) | $PR_COUNT | â„¹ï¸ New file |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> **Note:** New Dockerfile added with $PR_COUNT layers" >> "$GITHUB_STEP_SUMMARY"
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=New Dockerfile with $PR_COUNT layers" >> "$GITHUB_OUTPUT"
          elif [ "$PR_COUNT" -gt "$BASE_COUNT" ]; then
            DIFF=$((PR_COUNT - BASE_COUNT))
            echo "| ${{ matrix.dockerfile.path }} | $BASE_COUNT | $PR_COUNT | âŒ +$DIFF |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> **Error:** This PR adds $DIFF layer(s) to ${{ matrix.dockerfile.path }}" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### How to fix" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "To maintain Docker build performance and caching efficiency, please combine your changes with existing layers where possible:" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- Combine multiple \`RUN\` commands using \`&&\`" >> "$GITHUB_STEP_SUMMARY"
            echo "- Combine multiple \`COPY\` commands where possible" >> "$GITHUB_STEP_SUMMARY"
            echo "- Consider if the change is truly necessary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "If adding layers is intentional and necessary, please explain in the PR description." >> "$GITHUB_STEP_SUMMARY"
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "message=Added $DIFF layer(s)" >> "$GITHUB_OUTPUT"
          elif [ "$PR_COUNT" -lt "$BASE_COUNT" ]; then
            DIFF=$((BASE_COUNT - PR_COUNT))
            echo "| ${{ matrix.dockerfile.path }} | $BASE_COUNT | $PR_COUNT | âœ… -$DIFF |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> **Success:** This PR removes $DIFF layer(s) from ${{ matrix.dockerfile.path }} ðŸŽ‰" >> "$GITHUB_STEP_SUMMARY"
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=Removed $DIFF layer(s)" >> "$GITHUB_OUTPUT"
          else
            echo "| ${{ matrix.dockerfile.path }} | $BASE_COUNT | $PR_COUNT | âœ… No change |" >> "$GITHUB_STEP_SUMMARY"
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "message=No layer change" >> "$GITHUB_OUTPUT"
          fi

      - name: Report result
        run: |
          echo "Dockerfile: ${{ matrix.dockerfile.path }}"
          echo "Status: ${{ steps.compare.outputs.status }}"
          echo "Message: ${{ steps.compare.outputs.message }}"

          if [ "${{ steps.compare.outputs.status }}" = "failure" ]; then
            echo "::error::${{ matrix.dockerfile.path }}: ${{ steps.compare.outputs.message }}"
            exit 1
          fi
